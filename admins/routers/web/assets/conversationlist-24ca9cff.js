import{L as F,M as R,r as q,f as m,c as a,b as s,q as B,v as I,u as n,N as O,F as $,e as w,d as T,x as M,t as l,l as v,O as C,p as D,R as K,o,i as z,n as P}from"./index-0f2e41f6.js";import{_ as p}from"./avatar-04bd5dd2.js";import{c as U}from"./common-eab97762.js";import"./user-2c36cc99.js";function Y(k={}){let{limit:_=50,start:h,app_key:g}=k,f=`${F.MSG_MANAGER_CONVER_LIST}?app_key=${g}&count=${_}&start=${h}`;return R(f,{method:"GET"})}function J(k={}){let{limit:_=50,start:h=0,app_key:g,sender_id:f,channel_type:x,receiver_id:t}=k,b=`${F.MSG_MANAGER_HISTORY_LIST}?app_key=${g}&count=${_}&channel_type=${x}&from_id=${f}&target_id=${t}&start=${h}`;return R(b,{method:"GET"})}const G={getConversations:Y,getMessages:J},Q={class:"mb-4 cim-log-contanier"},W={class:"cim-log-header"},X={class:"cim-log-header-lf-box"},Z={class:"cim-log-lf-item"},ss={class:"cim-log-lf-item"},es={class:"cim-conversationlist-body"},ts={class:"cim-conversation-wrapper"},is={class:"cim-conversation-body"},ns={class:"table cim-table"},rs={class:"cim-td-c cim-conver-type"},as={class:"cim-td-c"},os={key:0,class:"cim-conver-info-box"},cs={class:"cim-userlist-info cim-conver-info"},ls={class:"nickname"},ds={key:1,class:"cim-conver-info-box"},ms={class:"cim-userlist-info cim-conver-info"},us={class:"nickname"},_s={class:"cim-userlist-info cim-conver-info"},vs={class:"nickname"},ps={class:"cim-td-c"},gs={class:"cim-td-c"},hs={class:"cim-table-tools"},fs={class:"cim-table-tool"},ys=["onClick"],ks={class:"cim-conversation-footer"},xs={class:"cim-navigation"},bs={class:"pagination"},Ms={class:"page-item"},Ts={key:0,class:"cim-message-wrapper"},Es={class:"header"},Ns={class:"conversation-info"},Ss={class:"cim-conver-type"},$s={key:0,class:"cim-conver-info-box"},ws={class:"cim-userlist-info cim-conver-info"},Cs={class:"nickname"},Ps={key:1,class:"cim-conver-info-box"},Gs={class:"cim-userlist-info cim-conver-info"},Fs={class:"nickname"},Rs={class:"cim-userlist-info cim-conver-info"},Ls={class:"nickname"},Vs={class:"body"},As={class:"message-list",ref:"messageList"},Hs={class:"message-item"},js={class:"message-header"},qs={class:"message-sender"},Bs={key:0,class:"message-text"},Is={key:1,class:"message-image"},Os=["src"],Ds={key:2,class:"message-image"},Ks=["src"],zs={key:3,class:"message-file"},Us=["href","download"],Ys={class:"cim-file-group"},Js={class:"cim-file-info"},Qs={class:"name"},Ws={class:"meta"},Xs={key:4,class:"message-text"},Zs={class:"message-time"},se={key:0,class:"none"},re={__name:"conversationlist",setup(k){const _=z();let h=D(),{currentRoute:{_rawValue:{params:{app_key:g}}}}=h,f={start:0,limit:50,app_key:g,keywords:""},x={start:0,limit:50,app_key:g},t=q({params:m.clone(f),msgParams:m.clone(x),list:[],isFinished:!1,page:1,lastScrollTop:0,messages:[],current:{}});function b(r,i="yyyy-MM-dd"){return m.formatTime(new Date(r).getTime(),i)}function L(){E()}function V(r){m.extend(t,{messages:[],current:r,msgParams:m.clone(x),isMsgFinished:!1}),r.isGroup?t.msgParams.receiver_id=r.group.group_id:t.msgParams.receiver_id=r.receiver.user_id,t.msgParams.sender_id=r.sender.user_id,t.msgParams.channel_type=r.channel_type,P(()=>{let{messageList:i}=_.refs;i.addEventListener("scroll",j(()=>{i.scrollTop<100&&N(t.msgParams)},200)),N(t.msgParams)})}function E(){let r={...t.params};G.getConversations(r).then(i=>{let{code:e,data:c,msg:y=""}=i;if(m.isEqual(e,K.SUCCESS)){let{items:u}=c;u=m.map(u,d=>{let S=d.channel_type==2;return d.channelName=S?"群聊":"单聊",d.isGroup=S,d.formTime=b(d.time,"yyyy-MM-dd hh:mm:ss"),d}),t.list=t.list.concat(u),m.isEmpty(u)||(t.params.start=u[u.length-1].time),t.isFinished=r.limit>u.length}else _.proxy.$toast({icon:"error",text:`Error: ${e} ${y}`})})}E();function A(r){let i=r.sender.user_id;return U.getAvatarNum(i)}function H(r){return m.isEqual(r.time,t.current.time)}function j(r,i){let e;return function(...c){const y=this;clearTimeout(e),e=setTimeout(()=>r.apply(y,c),i)}}async function N(r){if(t.isMsgFinished)return;let{messageList:i}=_.refs;const e=await G.getMessages(r);let{items:c}=e.data;if(c=c||[],c.length>0){const y=i.scrollTop,u=i.scrollHeight;c.reverse(),c=m.map(c,d=>(d.content=m.parse(d.msg_content),d)),t.messages=c.concat(t.messages),t.msgParams.start=c[0].msg_time,P(()=>{const d=i.scrollHeight;i.scrollTop=y+(d-u-200)})}t.isMsgFinished=t.msgParams.limit>c.length}return(r,i)=>(o(),a("div",Q,[s("div",W,[s("ul",X,[s("li",Z,[B(s("input",{class:"form-control",type:"text","onUpdate:modelValue":i[0]||(i[0]=e=>n(t).params.keywords=e),placeholder:"用户名称",autocomplete:"off",onKeydown:i[1]||(i[1]=O((...e)=>r.onSearch&&r.onSearch(...e),["enter"]))},null,544),[[I,n(t).params.keywords]])]),s("li",ss,[s("div",{class:"cim-button cim-button-bg",onClick:i[2]||(i[2]=(...e)=>r.onSearch&&r.onSearch(...e))},"查询")])])]),s("div",es,[s("div",ts,[s("div",is,[s("table",ns,[i[4]||(i[4]=s("thead",null,[s("tr",null,[s("th",{class:"cim-td-c center"},"会话类型"),s("th",{class:"cim-td-c"},"会话信息"),s("th",{class:"cim-td-c"},"会话最后发送消息时间"),s("th",{class:"cim-td-c"},"操作")])],-1)),s("tbody",null,[(o(!0),a($,null,w(n(t).list,e=>(o(),a("tr",{class:M([H(e)?"selected":""])},[s("td",rs,[s("span",{class:M(["tip",[e.isGroup?"group-tip":"user-tip"]])},l(e.channelName),3)]),s("td",as,[e.isGroup?(o(),a("div",os,[s("div",cs,[v(p,{"user-id":e.group.group_id,name:e.group.group_name,avatar:e.group.group_portrait,cls:"cim-xsmall-avatar"},null,8,["user-id","name","avatar"]),s("div",ls,l(e.group.group_name),1)])])):(o(),a("div",ds,[s("div",ms,[v(p,{"user-id":e.receiver.user_id,name:e.receiver.nickname||e.receiver.user_id,avatar:e.receiver.avatar,cls:"cim-xsmall-avatar"},null,8,["user-id","name","avatar"]),s("div",us,l(e.receiver.nickname||e.receiver.user_id),1)]),i[3]||(i[3]=C(" ~ ")),s("div",_s,[v(p,{"user-id":e.sender.user_id,name:e.sender.nickname||e.sender.user_id,avatar:e.sender.avatar,cls:"cim-xsmall-avatar"},null,8,["user-id","name","avatar"]),s("div",vs,l(e.sender.nickname||e.sender.user_id),1)])]))]),s("td",ps,l(e.formTime),1),s("td",gs,[s("ul",hs,[s("li",fs,[s("a",{class:"btn-link",href:"#",onClick:c=>V(e)},"查看消息",8,ys)])])])],2))),256))])])]),s("div",ks,[s("nav",xs,[s("ul",bs,[s("li",Ms,[n(t).isFinished?T("",!0):(o(),a("a",{key:0,class:"page-link",href:"#","aria-label":"Next",onClick:L},i[5]||(i[5]=[s("span",{"aria-hidden":"true"},"下一页",-1)])))])])])])]),n(m).isEmpty(n(t).current)?T("",!0):(o(),a("div",Ts,[s("div",Es,[s("div",Ns,[s("div",Ss,[s("span",{class:M(["tip",[n(t).current.isGroup?"group-tip":"user-tip"]])},l(n(t).current.channelName),3)]),n(t).current.isGroup?(o(),a("div",$s,[s("div",ws,[v(p,{"user-id":n(t).current.group.group_id,name:n(t).current.group.group_name,avatar:n(t).current.group.group_portrait,cls:"cim-xsmall-avatar"},null,8,["user-id","name","avatar"]),s("div",Cs,l(n(t).current.group.group_name),1)])])):(o(),a("div",Ps,[s("div",Gs,[v(p,{"user-id":n(t).current.receiver.user_id,name:n(t).current.receiver.nickname||n(t).current.receiver.user_id,avatar:n(t).current.receiver.avatar,cls:"cim-xsmall-avatar"},null,8,["user-id","name","avatar"]),s("div",Fs,l(n(t).current.receiver.nickname||n(t).current.receiver.user_id),1)]),i[6]||(i[6]=C(" ~ ")),s("div",Rs,[v(p,{"user-id":n(t).current.sender.user_id,name:n(t).current.sender.nickname||n(t).current.sender.user_id,avatar:n(t).current.sender.avatar,cls:"cim-xsmall-avatar"},null,8,["user-id","name","avatar"]),s("div",Ls,l(n(t).current.sender.nickname||n(t).current.sender.user_id),1)])]))])]),s("div",Vs,[s("ul",As,[(o(!0),a($,null,w(n(t).messages,(e,c)=>(o(),a("li",Hs,[v(p,{"user-id":e.sender.user_id,name:e.sender.nickname,avatar:e.sender.avatar,cls:"cim-small-avatar"},null,8,["user-id","name","avatar"]),s("div",{class:M(["message-content",["jg-peer-color-"+A(e)]])},[s("div",js,[s("div",qs,l(e.sender.nickname||e.sender.user_id),1)]),e.msg_type=="jg:text"?(o(),a("div",Bs,l(e.content.content),1)):e.msg_type=="jg:img"?(o(),a("div",Is,[s("img",{src:e.content.thumbnail,class:"cim-msg-image",alt:""},null,8,Os)])):e.msg_type=="jg:video"?(o(),a("div",Ds,[s("video",{src:e.content.url,ref_for:!0,ref:"video",class:"cim-msg-image",controls:""},null,8,Ks)])):e.msg_type=="jg:file"?(o(),a("div",zs,[s("a",{href:e.content.url,class:"cim-msg-file",download:e.content.name},[s("div",Ys,[i[7]||(i[7]=s("div",{class:"cicon cicon-file"},null,-1)),s("div",Js,[s("h6",Qs,l(e.content.name),1),s("div",Ws,l((Number(e.content.size)||0).toFixed(2))+" KB",1)])])],8,Us)])):(o(),a("div",Xs,"暂不支持查看")),s("div",Zs,l(b(e.msg_time,"yyyy-MM-dd hh:mm:ss")),1)],2)]))),256)),s("li",null,[n(t).isMsgFinished&&n(t).messages.length==0?(o(),a("div",se,"没有消息~")):T("",!0)])],512)])]))])]))}};export{re as default};
