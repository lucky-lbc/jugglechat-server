import{r as N,z as V,o as r,B as H,w as P,b as e,c as d,e as g,t as p,u as i,F as L,_ as T,f as a,i as q,A as R,ai as O,aj as m,l as D,U as k,j as $,x as j,d as w,q as S,v as M,C as z}from"./index-0f2e41f6.js";import{U as v}from"./user-2c36cc99.js";const F={class:"cim-dialog-bind-app"},X={class:"cim-dialog-bind-box left"},Y={class:"bind-apps"},G={class:"bind-app"},J={class:"bind-app-info"},K={class:"bind-app-name"},Q={class:"bind-app-appkey"},W={class:"tools"},Z={class:"tool"},tt=["onClick"],st={class:"cim-dialog-bind-box right"},et={class:"bind-apps"},ot={class:"bind-app"},nt={class:"bind-app-info"},it={class:"bind-app-name"},at={class:"bind-app-appkey"},lt={class:"tools"},rt={class:"tool"},dt=["onClick"],ct={__name:"dialog-bind-app",props:["title","text","account","show"],emits:["save","hide"],setup(I,{emit:f}){const h=q(),o=I,b=f;let l=N({appList:[],bandAppList:[],removeBindList:[]});async function A(){l.removeBindList.length>0&&await v.unBindApp({account:o.account,app_keys:l.removeBindList.map(n=>n.app_key)}),v.bindApp({account:o.account,app_keys:l.bandAppList.map(n=>n.app_key)}).then(n=>{h.proxy.$toast({icon:"success",text:"绑定成功"}),b("save",{})})}function x(n){b("hide",{})}function B(n,t){l.bandAppList.push(n),l.appList.splice(t,1)}function y(n,t){l.appList.push(n),l.bandAppList.splice(t,1),n.isBind&&l.removeBindList.push(n)}async function U(){let t=(await R.getList()).data.items||[],c=(await R.getList({account:o.account})).data.items||[];c=c.map(u=>({...u,isBind:!0})),l.appList=a.filter(t,u=>a.find(c,_=>_.app_key==u.app_key)==-1),l.bandAppList=c}return V(()=>o.show,n=>{n?U():a.extend(l,{appList:[],bandAppList:[],removeBindList:[]})}),(n,t)=>(r(),H(T,{title:o.title,show:o.show,"btn-title":o.text,onHide:x,onSave:A,cls:"cim-dialog-bind-modal"},{default:P(()=>[e("div",F,[e("div",X,[t[0]||(t[0]=e("div",{class:"bind-header"},"应用列表",-1)),e("ul",Y,[(r(!0),d(L,null,g(i(l).appList,(s,c)=>(r(),d("li",G,[e("div",J,[e("div",K,p(s.app_name),1),e("div",Q,p(s.app_key),1)]),e("div",W,[e("div",Z,[e("span",{class:"cicon cicon-add",onClick:u=>B(s,c)},null,8,tt)])])]))),256))])]),e("div",st,[t[1]||(t[1]=e("div",{class:"bind-header"},"已绑定列表",-1)),e("ul",et,[(r(!0),d(L,null,g(i(l).bandAppList,(s,c)=>(r(),d("li",ot,[e("div",nt,[e("div",it,p(s.app_name),1),e("div",at,p(s.app_key),1)]),e("div",lt,[e("div",rt,[e("span",{class:"cicon cicon-close",onClick:u=>y(s,c)},null,8,dt)])])]))),256))])])])]),_:1},8,["title","show","btn-title"]))}},pt={class:"mb-4"},ut={class:"header cim-header"},mt={class:"table cim-table"},ft={class:"cim-td-c cim-td-operate"},_t=["onClick"],vt=["onClick"],bt=["onClick"],Et={class:"row g-2 cim-row"},wt={class:"form-floating"},yt=["disabled"],kt={key:0,class:"invalid-feedback feedback"},ht={class:"form-floating"},$t={key:0,class:"invalid-feedback feedback"},St={class:"form-floating"},gt={key:0,class:"invalid-feedback feedback"},Lt={class:"form-floating"},At=["value"],Ut={__name:"manager",setup(I){let f=q(),h={account:"",password:"",confirmPasswrod:"",state:m.ENABLE,role:k.ADMIN},o=N({users:[],roles:a.clone(O),radios:[{name:"type",value:m.ENABLE,label:"启用"},{name:"type",value:m.DISABLE,label:"禁用"}],isShowEdit:!1,user:a.clone(h),accountErrorMsg:"",pwdErrorMsg:"",conPwdErrorMsg:"",isShowBindApp:!1,selectUser:{}});v.getUsers().then(({data:n})=>{let{items:t}=n;o.users=t.map(s=>(s.time=a.formatTime(s.created_time),s))});function b(n,t){o.isShowEdit=n,t&&(o.user=t),n||(o.user=a.clone(h))}function l(n,t){o.isShowBindApp=n,o.selectUser=n?t:{}}function A(n){let t;a.isEqual(n.state,m.ENABLE)&&(t=m.DISABLE),a.isEqual(n.state,m.DISABLE)&&(t=m.ENABLE),v.disable({accounts:[n.account],is_disable:t}).then(()=>{o.users.map(s=>(a.isEqual(n.account,s.account)&&a.extend(s,{state:t}),s)),f.proxy.$toast({icon:"success",text:"操作成功",duration:4e3})})}function x(n){let t=o.users[n];v.remove({accounts:[t.account]}).then(()=>{o.users.splice(n,1),f.proxy.$toast({icon:"success",text:"删除成功",duration:4e3})})}function B(){let{user:n}=o,{account:t,password:s,confirmPasswrod:c,role:u}=n;if(a.isEmpty(t))return o.accountErrorMsg="账户名称不能为空";if(a.isEmpty(s))return o.pwdErrorMsg="密码不能为空";if(!a.isEqual(c,s))return o.conPwdErrorMsg="两次密码输入不一致";if(n.created_time)return v.updatePwd({account:t,password:s,new_password:c,role_type:u}).then(({code:E,msg:_})=>{a.isEqual(E,$.SUCCESS_0.code)?f.proxy.$toast({icon:"success",text:"修改密码成功",duration:3e3}):f.proxy.$toast({icon:"error",text:`${E}:${_}`,duration:3e3})});v.add({account:t,password:s,state:n.state,role_type:u}).then(({code:E})=>{let _="success",C="保存成功";a.isEqual(E,$.SUCCESS_0.code)?(n.time=a.formatTime(Date.now()),o.users.push(n),b(!1)):a.isEqual(E,$.USER_EXISTS.code)?(_="error",C=$.USER_EXISTS.msg):(_="error",C="保存失败，请重试"),f.proxy.$toast({icon:_,text:C,duration:4e3})})}function y(n){({account:()=>{o.accountErrorMsg=""},pwd:()=>{o.pwdErrorMsg=""},confirm:()=>{o.conPwdErrorMsg=""}})[n]()}function U(){l(!1,{})}return(n,t)=>(r(),d("div",pt,[e("div",ut,[t[12]||(t[12]=e("div",{class:"cim-title"},"用户管理",-1)),e("div",{class:"cicon cicon-add cim-button cim-button-bg",onClick:t[0]||(t[0]=s=>b(!0))},"添加用户")]),e("table",mt,[t[14]||(t[14]=e("thead",null,[e("tr",null,[e("th",null,"用户账号"),e("th",null,"账户类型"),e("th",null,"用户密码"),e("th",null,"是否启用"),e("th",null,"创建时间"),e("th",{class:"cim-td-c"},"操作")])],-1)),e("tbody",null,[(r(!0),d(L,null,g(i(o).users,(s,c)=>(r(),d("tr",null,[e("td",null,p(s.account),1),e("td",null,p(s.role_type==i(k).ADMIN?"管理员":"普通用户"),1),t[13]||(t[13]=e("td",null,"**** ****",-1)),e("td",{class:j(["cicon",{"cicon-success":s.state==i(m).ENABLE,"cicon-error":s.state==i(m).DISABLE}])},p(s.state==i(m).ENABLE?"已启用":"已禁用"),3),e("td",null,p(s.time),1),e("td",ft,[s.role_type==i(k).USER?(r(),d("a",{key:0,class:"btn-link cim-btn-link",type:"button",onClick:u=>l(!0,s)},"绑定应用",8,_t)):w("",!0),s.role_type==i(k).USER?(r(),d("a",{key:1,class:"btn-link cim-btn-link",type:"button",onClick:u=>A(s)},p(s.state==i(m).DISABLE?"启用":"禁用"),9,vt)):w("",!0),s.role_type==i(k).USER?(r(),d("a",{key:2,class:"btn-link cim-btn-link",type:"button",onClick:u=>x(c)},"删除",8,bt)):w("",!0)])]))),256))])]),D(T,{show:i(o).isShowEdit,title:"添加用户",onHide:t[8]||(t[8]=s=>b(!1)),onSave:t[9]||(t[9]=s=>B())},{default:P(()=>[e("div",Et,[e("div",wt,[S(e("input",{class:"form-control",disabled:i(o).user.created_time,"onUpdate:modelValue":t[1]||(t[1]=s=>i(o).user.account=s),type:"text",placeholder:"用户名称",autocomplete:"off",onInput:t[2]||(t[2]=s=>y("account"))},null,40,yt),[[M,i(o).user.account]]),t[15]||(t[15]=e("label",null,"用户名称",-1)),i(o).accountErrorMsg?(r(),d("div",kt,p(i(o).accountErrorMsg),1)):w("",!0)]),e("div",ht,[S(e("input",{class:"form-control","onUpdate:modelValue":t[3]||(t[3]=s=>i(o).user.password=s),type:"text",placeholder:"用户密码",onInput:t[4]||(t[4]=s=>y("pwd"))},null,544),[[M,i(o).user.password]]),t[16]||(t[16]=e("label",null,"用户密码",-1)),i(o).pwdErrorMsg?(r(),d("div",$t,p(i(o).pwdErrorMsg),1)):w("",!0)]),e("div",St,[S(e("input",{class:"form-control","onUpdate:modelValue":t[5]||(t[5]=s=>i(o).user.confirmPasswrod=s),type:"text",placeholder:"确认密码",onInput:t[6]||(t[6]=s=>y("confirm"))},null,544),[[M,i(o).user.confirmPasswrod]]),t[17]||(t[17]=e("label",null,"确认密码",-1)),i(o).conPwdErrorMsg?(r(),d("div",gt,p(i(o).conPwdErrorMsg),1)):w("",!0)]),e("div",Lt,[S(e("select",{class:"form-select","onUpdate:modelValue":t[7]||(t[7]=s=>i(o).user.role=s)},[(r(!0),d(L,null,g(i(o).roles,s=>(r(),d("option",{value:s.value},p(s.name),9,At))),256))],512),[[z,i(o).user.role]]),t[18]||(t[18]=e("label",null,"用户角色",-1))]),t[19]||(t[19]=e("input",{type:"password",autocomplete:"new-password",style:{display:"none"}},null,-1))])]),_:1},8,["show"]),D(ct,{show:i(o).isShowBindApp,title:"绑定应用",account:i(o).selectUser.account,onHide:t[10]||(t[10]=s=>l(!1)),onSave:t[11]||(t[11]=s=>U())},null,8,["show","account"])]))}};export{Ut as default};
